// MyClinic Database Schema
// PostgreSQL + Prisma ORM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// Multi-tenant: Tenant (Clinic)
// ===========================================
model Tenant {
  id        String   @id @default(cuid())
  name      String
  settings  Json?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  branches                Branch[]
  users                   User[]
  patients                Patient[]
  services                Service[]
  leads                   Lead[]
  conversations           Conversation[]
  auditEvents             AuditEvent[]
  appointments            Appointment[]
  visits                  Visit[]
  invoices                Invoice[]
  expenses                Expense[]
  activityEvents          ActivityEvent[]
  attachments             Attachment[]
  sequences               TenantSequence[]
  notifications           Notification[]
  notificationPreferences NotificationPreference[]
  // Milestone 9 Relations
  inventoryCategories     InventoryCategory[]
  inventoryItems          InventoryItem[]
  inventoryMovements      InventoryMovement[]
  suppliers               Supplier[]
  purchaseOrders          PurchaseOrder[]
  scheduleTemplates       ScheduleTemplate[]
  workSchedules           WorkSchedule[]
  timeOffRequests         TimeOffRequest[]
  integrationConfigs      IntegrationConfig[]
  integrationLogs         IntegrationLog[]
  pushSubscriptions       PushSubscription[]

  @@map("tenants")
}

// ===========================================
// Multi-tenant: Branch
// ===========================================
model Branch {
  id        String   @id @default(cuid())
  tenantId  String   @map("tenant_id")
  name      String
  address   String?
  phone     String?
  settings  Json?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  patients      Patient[]
  appointments  Appointment[]
  visits        Visit[]
  invoices      Invoice[]
  expenses      Expense[]
  auditEvents   AuditEvent[]
  // Milestone 9 Relations
  workSchedules WorkSchedule[]

  @@map("branches")
}

// ===========================================
// Authentication: User
// ===========================================
model User {
  id               String     @id @default(cuid())
  tenantId         String     @map("tenant_id")
  email            String     @unique
  phone            String?
  name             String
  passwordHash     String     @map("password_hash")
  role             Role       @default(RECEPTION)
  branchIds        String[]   @map("branch_ids")
  twoFactorEnabled Boolean    @default(false) @map("two_factor_enabled")
  twoFactorSecret  String?    @map("two_factor_secret")
  status           UserStatus @default(ACTIVE)
  language         Language   @default(ar)
  lastLoginAt      DateTime?  @map("last_login_at")
  createdAt        DateTime   @default(now()) @map("created_at")
  updatedAt        DateTime   @updatedAt @map("updated_at")

  // Relations
  tenant                 Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  visits                 Visit[]                 @relation("DoctorVisits")
  appointments           Appointment[]           @relation("DoctorAppointments")
  assignedConversations  Conversation[]          @relation("AssignedConversations")
  assignedTasks          Task[]                  @relation("AssignedTasks")
  createdTasks           Task[]                  @relation("CreatedTasks")
  payments               Payment[]
  expenses               Expense[]
  attachments            Attachment[]
  activityEvents         ActivityEvent[]         @relation("ActorEvents")
  auditEvents            AuditEvent[]            @relation("UserAuditEvents")
  messages               Message[]
  notifications          Notification[]
  notificationPreference NotificationPreference?
  // Milestone 9 Relations
  inventoryMovements     InventoryMovement[]     @relation("InventoryMovements")
  purchaseOrdersApproved PurchaseOrder[]         @relation("PurchaseOrderApprover")
  purchaseOrdersReceived PurchaseOrder[]         @relation("PurchaseOrderReceiver")
  purchaseOrdersCreated  PurchaseOrder[]         @relation("PurchaseOrderCreator")
  workSchedules          WorkSchedule[]          @relation("UserWorkSchedules")
  timeOffRequests        TimeOffRequest[]        @relation("UserTimeOffRequests")
  timeOffReviews         TimeOffRequest[]        @relation("TimeOffReviewer")
  integrationLogs        IntegrationLog[]        @relation("IntegrationLogTriggeredBy")
  pushSubscriptions      PushSubscription[]      @relation("UserPushSubscriptions")

  @@map("users")
}

enum Role {
  ADMIN
  MANAGER
  RECEPTION
  DOCTOR
  NURSE
  ACCOUNTANT
  SUPPORT
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum Language {
  ar
  en
  ckb
  kmr
}

// ===========================================
// Patient
// ===========================================
model Patient {
  id             String        @id @default(cuid())
  tenantId       String        @map("tenant_id")
  branchId       String        @map("branch_id")
  fileNumber     String        @map("file_number")
  name           String
  phone          String
  email          String?
  dateOfBirth    DateTime?     @map("date_of_birth")
  gender         Gender?
  address        String?
  medicalSummary Json?         @map("medical_summary")
  source         PatientSource @default(WALK_IN)
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")
  deletedAt      DateTime?     @map("deleted_at")

  // Relations
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  branch        Branch         @relation(fields: [branchId], references: [id])
  appointments  Appointment[]
  visits        Visit[]
  invoices      Invoice[]
  conversations Conversation[]
  lead          Lead?

  @@unique([tenantId, fileNumber])
  @@index([tenantId, phone])
  @@index([tenantId, name])
  @@map("patients")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum PatientSource {
  WALK_IN
  REFERRAL
  WEBSITE
  WHATSAPP
  SOCIAL_MEDIA
  PHONE
  OTHER
}

// ===========================================
// Service
// ===========================================
model Service {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  name            String
  nameAr          String?  @map("name_ar")
  nameEn          String?  @map("name_en")
  nameCkb         String?  @map("name_ckb")
  nameKmr         String?  @map("name_kmr")
  durationMinutes Int      @map("duration_minutes")
  price           Decimal  @db.Decimal(10, 2)
  category        String?
  active          Boolean  @default(true)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  appointments Appointment[]

  @@map("services")
}

// ===========================================
// Appointment
// ===========================================
model Appointment {
  id               String            @id @default(cuid())
  tenantId         String            @map("tenant_id")
  branchId         String            @map("branch_id")
  patientId        String            @map("patient_id")
  doctorId         String            @map("doctor_id")
  serviceId        String            @map("service_id")
  scheduledAt      DateTime          @map("scheduled_at")
  durationMinutes  Int               @map("duration_minutes")
  status           AppointmentStatus @default(NEW)
  arrivalTime      DateTime?         @map("arrival_time")
  checkInTime      DateTime?         @map("check_in_time")
  checkOutTime     DateTime?         @map("check_out_time")
  rescheduleReason String?           @map("reschedule_reason")
  cancelReason     String?           @map("cancel_reason")
  notes            String?
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")

  // Relations
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  branch   Branch    @relation(fields: [branchId], references: [id])
  patient  Patient   @relation(fields: [patientId], references: [id])
  doctor   User      @relation("DoctorAppointments", fields: [doctorId], references: [id])
  service  Service   @relation(fields: [serviceId], references: [id])
  visit    Visit?
  invoices Invoice[]

  @@index([tenantId, branchId, scheduledAt])
  @@index([tenantId, doctorId, scheduledAt])
  @@index([tenantId, patientId])
  @@map("appointments")
}

enum AppointmentStatus {
  NEW
  CONFIRMED
  ARRIVED
  IN_PROGRESS
  COMPLETED
  NO_SHOW
  CANCELLED
  RESCHEDULED
}

// ===========================================
// Visit (Medical Record)
// ===========================================
model Visit {
  id             String   @id @default(cuid())
  tenantId       String   @map("tenant_id")
  branchId       String   @map("branch_id")
  patientId      String   @map("patient_id")
  appointmentId  String?  @unique @map("appointment_id")
  doctorId       String   @map("doctor_id")
  chiefComplaint String?  @map("chief_complaint")
  diagnosis      String?
  treatmentNotes String?  @map("treatment_notes")
  prescriptions  Json?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  branch      Branch       @relation(fields: [branchId], references: [id])
  patient     Patient      @relation(fields: [patientId], references: [id])
  appointment Appointment? @relation(fields: [appointmentId], references: [id])
  doctor      User         @relation("DoctorVisits", fields: [doctorId], references: [id])
  invoices    Invoice[]

  @@index([tenantId, patientId])
  @@index([tenantId, doctorId])
  @@index([tenantId, branchId])
  @@map("visits")
}

// ===========================================
// Invoice
// ===========================================
model Invoice {
  id             String        @id @default(cuid())
  tenantId       String        @map("tenant_id")
  branchId       String        @map("branch_id")
  patientId      String        @map("patient_id")
  appointmentId  String?       @map("appointment_id")
  visitId        String?       @map("visit_id")
  invoiceNumber  String        @map("invoice_number")
  items          Json
  subtotal       Decimal       @db.Decimal(10, 2)
  discount       Decimal?      @db.Decimal(10, 2)
  discountReason String?       @map("discount_reason")
  tax            Decimal?      @db.Decimal(10, 2)
  total          Decimal       @db.Decimal(10, 2)
  paidAmount     Decimal       @default(0) @map("paid_amount") @db.Decimal(10, 2)
  status         InvoiceStatus @default(PENDING)
  dueDate        DateTime?     @map("due_date")
  notes          String?
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  // Relations
  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  branch      Branch       @relation(fields: [branchId], references: [id])
  patient     Patient      @relation(fields: [patientId], references: [id])
  appointment Appointment? @relation(fields: [appointmentId], references: [id])
  visit       Visit?       @relation(fields: [visitId], references: [id])
  payments    Payment[]

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId, branchId, createdAt])
  @@index([tenantId, patientId])
  @@map("invoices")
}

enum InvoiceStatus {
  DRAFT
  PENDING
  PARTIAL
  PAID
  CANCELLED
  REFUNDED
}

// ===========================================
// Payment
// ===========================================
model Payment {
  id        String        @id @default(cuid())
  invoiceId String        @map("invoice_id")
  amount    Decimal       @db.Decimal(10, 2)
  method    PaymentMethod
  reference String?
  notes     String?
  createdBy String        @map("created_by")
  createdAt DateTime      @default(now()) @map("created_at")

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id])
  user    User    @relation(fields: [createdBy], references: [id])

  @@map("payments")
}

enum PaymentMethod {
  CASH
  CARD
  BANK_TRANSFER
  ONLINE
  OTHER
}

// ===========================================
// Expense
// ===========================================
model Expense {
  id          String          @id @default(cuid())
  tenantId    String          @map("tenant_id")
  branchId    String          @map("branch_id")
  category    ExpenseCategory
  amount      Decimal         @db.Decimal(10, 2)
  description String
  date        DateTime
  receiptUrl  String?         @map("receipt_url")
  createdBy   String          @map("created_by")
  createdAt   DateTime        @default(now()) @map("created_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  branch Branch @relation(fields: [branchId], references: [id])
  user   User   @relation(fields: [createdBy], references: [id])

  @@index([tenantId, branchId, date])
  @@map("expenses")
}

enum ExpenseCategory {
  RENT
  UTILITIES
  SUPPLIES
  EQUIPMENT
  SALARIES
  MARKETING
  MAINTENANCE
  OTHER
}

// ===========================================
// Lead (CRM)
// ===========================================
model Lead {
  id        String        @id @default(cuid())
  tenantId  String        @map("tenant_id")
  patientId String?       @unique @map("patient_id")
  name      String
  phone     String
  email     String?
  source    Channel
  stage     PipelineStage @default(INQUIRY)
  notes     String?
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")

  // Relations
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  patient       Patient?       @relation(fields: [patientId], references: [id])
  conversations Conversation[]

  @@index([tenantId, phone])
  @@map("leads")
}

enum PipelineStage {
  INQUIRY
  QUALIFIED
  BOOKED
  ARRIVED
  FOLLOW_UP
  RE_ENGAGE
  CONVERTED
  LOST
}

// ===========================================
// Conversation (Inbox)
// ===========================================
model Conversation {
  id            String             @id @default(cuid())
  tenantId      String             @map("tenant_id")
  channel       Channel
  externalId    String?            @map("external_id")
  leadId        String?            @map("lead_id")
  patientId     String?            @map("patient_id")
  assignedTo    String?            @map("assigned_to")
  tags          String[]
  pipelineStage PipelineStage?     @map("pipeline_stage")
  status        ConversationStatus @default(OPEN)
  lastMessageAt DateTime?          @map("last_message_at")
  createdAt     DateTime           @default(now()) @map("created_at")
  updatedAt     DateTime           @updatedAt @map("updated_at")

  // Relations
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lead     Lead?     @relation(fields: [leadId], references: [id])
  patient  Patient?  @relation(fields: [patientId], references: [id])
  assignee User?     @relation("AssignedConversations", fields: [assignedTo], references: [id])
  messages Message[]

  @@unique([tenantId, channel, externalId])
  @@index([tenantId, status])
  @@index([assignedTo])
  @@map("conversations")
}

enum Channel {
  WHATSAPP
  SMS
  EMAIL
  WEB_CHAT
  PHONE
}

enum ConversationStatus {
  OPEN
  PENDING
  RESOLVED
  CLOSED
}

// ===========================================
// Message
// ===========================================
model Message {
  id               String           @id @default(cuid())
  conversationId   String           @map("conversation_id")
  direction        MessageDirection
  content          String
  attachments      String[]
  isInternalNote   Boolean          @default(false) @map("is_internal_note")
  senderId         String?          @map("sender_id")
  externalSenderId String?          @map("external_sender_id")
  readAt           DateTime?        @map("read_at")
  createdAt        DateTime         @default(now()) @map("created_at")

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User?        @relation(fields: [senderId], references: [id])

  @@index([conversationId, createdAt])
  @@map("messages")
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

// ===========================================
// Task
// ===========================================
model Task {
  id          String         @id @default(cuid())
  tenantId    String         @map("tenant_id")
  entityType  TaskEntityType @map("entity_type")
  entityId    String         @map("entity_id")
  assignedTo  String         @map("assigned_to")
  title       String
  description String?
  dueDate     DateTime       @map("due_date")
  priority    TaskPriority   @default(MEDIUM)
  status      TaskStatus     @default(PENDING)
  completedAt DateTime?      @map("completed_at")
  createdBy   String         @map("created_by")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  // Relations
  assignee User @relation("AssignedTasks", fields: [assignedTo], references: [id])
  creator  User @relation("CreatedTasks", fields: [createdBy], references: [id])
  // Note: entityId is polymorphic - references Lead, Patient, Conversation, or Appointment
  // based on entityType. No FK constraint to allow flexibility.

  @@index([assignedTo, status])
  @@index([dueDate])
  @@index([entityType, entityId])
  @@map("tasks")
}

enum TaskEntityType {
  LEAD
  PATIENT
  CONVERSATION
  APPOINTMENT
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ===========================================
// Attachment
// ===========================================
model Attachment {
  id         String               @id @default(cuid())
  tenantId   String               @map("tenant_id")
  entityType AttachmentEntityType @map("entity_type")
  entityId   String               @map("entity_id")
  filePath   String               @map("file_path")
  fileName   String               @map("file_name")
  fileType   String               @map("file_type")
  fileSize   Int                  @map("file_size")
  uploadedBy String               @map("uploaded_by")
  createdAt  DateTime             @default(now()) @map("created_at")

  // Relations
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  uploader User   @relation(fields: [uploadedBy], references: [id])

  @@index([tenantId, entityType, entityId])
  @@map("attachments")
}

enum AttachmentEntityType {
  PATIENT
  VISIT
  APPOINTMENT
  INVOICE
  CONVERSATION
  COMMENT
}

// ===========================================
// Activity Event (Timeline)
// ===========================================
model ActivityEvent {
  id         String   @id @default(cuid())
  tenantId   String   @map("tenant_id")
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  action     String
  actorId    String   @map("actor_id")
  metadata   Json?
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  actor  User   @relation("ActorEvents", fields: [actorId], references: [id])

  @@index([tenantId, entityType, entityId])
  @@index([tenantId, actorId])
  @@map("activity_events")
}

// ===========================================
// Audit Event (Compliance Log)
// ===========================================
model AuditEvent {
  id            String   @id @default(cuid())
  tenantId      String   @map("tenant_id")
  branchId      String?  @map("branch_id")
  userId        String   @map("user_id")
  userRole      String   @map("user_role")
  entityType    String   @map("entity_type")
  entityId      String   @map("entity_id")
  action        String
  before        Json?
  after         Json?
  correlationId String?  @map("correlation_id")
  ipAddress     String?  @map("ip_address")
  userAgent     String?  @map("user_agent")
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  branch Branch? @relation(fields: [branchId], references: [id])
  user   User    @relation("UserAuditEvents", fields: [userId], references: [id])

  @@index([tenantId, entityType, entityId])
  @@index([tenantId, createdAt])
  @@index([correlationId])
  @@map("audit_events")
}

// ===========================================
// Tenant Sequence (Atomic Number Generation)
// ===========================================
model TenantSequence {
  id        String       @id @default(cuid())
  tenantId  String       @map("tenant_id")
  type      SequenceType
  year      Int?
  month     Int?
  value     Int          @default(0)
  updatedAt DateTime     @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, type, year, month])
  @@map("tenant_sequences")
}

enum SequenceType {
  PATIENT_FILE_NUMBER
  INVOICE_NUMBER
  PURCHASE_ORDER_NUMBER
}

// ===========================================
// Notification
// ===========================================
model Notification {
  id         String           @id @default(cuid())
  tenantId   String           @map("tenant_id")
  userId     String           @map("user_id")
  type       NotificationType
  title      String
  message    String
  entityType String?          @map("entity_type")
  entityId   String?          @map("entity_id")
  metadata   Json?
  isRead     Boolean          @default(false) @map("is_read")
  readAt     DateTime?        @map("read_at")
  createdAt  DateTime         @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId, userId, isRead])
  @@index([tenantId, userId, createdAt])
  @@map("notifications")
}

enum NotificationType {
  APPOINTMENT_CREATED
  APPOINTMENT_CANCELLED
  APPOINTMENT_RESCHEDULED
  PATIENT_ASSIGNED
  TASK_ASSIGNED
  TASK_COMPLETED
  LEAD_STAGE_CHANGED
  INVOICE_PAID
  INVOICE_OVERDUE
  MESSAGE_RECEIVED
  SYSTEM
  // Milestone 9: Inventory notifications
  LOW_STOCK_ALERT
  STOCK_EXPIRED
  PURCHASE_ORDER_APPROVED
  PURCHASE_ORDER_RECEIVED
  // Milestone 9: Scheduling notifications
  TIME_OFF_REQUESTED
  TIME_OFF_APPROVED
  TIME_OFF_REJECTED
  SCHEDULE_CHANGED
}

// ===========================================
// Notification Preference
// ===========================================
model NotificationPreference {
  id                     String   @id @default(cuid())
  tenantId               String   @map("tenant_id")
  userId                 String   @unique @map("user_id")
  appointmentCreated     Boolean  @default(true) @map("appointment_created")
  appointmentCancelled   Boolean  @default(true) @map("appointment_cancelled")
  appointmentRescheduled Boolean  @default(true) @map("appointment_rescheduled")
  taskAssigned           Boolean  @default(true) @map("task_assigned")
  taskCompleted          Boolean  @default(true) @map("task_completed")
  leadStageChanged       Boolean  @default(true) @map("lead_stage_changed")
  invoicePaid            Boolean  @default(true) @map("invoice_paid")
  invoiceOverdue         Boolean  @default(true) @map("invoice_overdue")
  messageReceived        Boolean  @default(true) @map("message_received")
  systemNotifications    Boolean  @default(true) @map("system_notifications")
  // Milestone 9: Inventory notification preferences
  lowStockAlert          Boolean  @default(true) @map("low_stock_alert")
  stockExpired           Boolean  @default(true) @map("stock_expired")
  purchaseOrderApproved  Boolean  @default(true) @map("purchase_order_approved")
  purchaseOrderReceived  Boolean  @default(true) @map("purchase_order_received")
  // Milestone 9: Scheduling notification preferences
  timeOffRequested       Boolean  @default(true) @map("time_off_requested")
  timeOffApproved        Boolean  @default(true) @map("time_off_approved")
  timeOffRejected        Boolean  @default(true) @map("time_off_rejected")
  scheduleChanged        Boolean  @default(true) @map("schedule_changed")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

// ===========================================
// MILESTONE 9: Inventory Management
// ===========================================

// Inventory Category - Hierarchical categories for inventory items
model InventoryCategory {
  id        String   @id @default(cuid())
  tenantId  String   @map("tenant_id")
  parentId  String?  @map("parent_id")
  name      String
  nameAr    String?  @map("name_ar")
  nameEn    String?  @map("name_en")
  nameCkb   String?  @map("name_ckb")
  nameKmr   String?  @map("name_kmr")
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant   Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parent   InventoryCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children InventoryCategory[] @relation("CategoryHierarchy")
  items    InventoryItem[]

  @@index([tenantId])
  @@index([tenantId, parentId])
  @@map("inventory_categories")
}

// Stock Unit types for inventory items
enum StockUnit {
  PIECES
  BOXES
  PACKS
  BOTTLES
  TUBES
  VIALS
  SYRINGES
  PAIRS
  SETS
  LITERS
  MILLILITERS
  KILOGRAMS
  GRAMS
  METERS
  OTHER
}

// Inventory Item - Stock items with quantities and reorder points
model InventoryItem {
  id              String    @id @default(cuid())
  tenantId        String    @map("tenant_id")
  categoryId      String?   @map("category_id")
  supplierId      String?   @map("supplier_id")
  sku             String
  barcode         String?
  name            String
  nameAr          String?   @map("name_ar")
  nameEn          String?   @map("name_en")
  nameCkb         String?   @map("name_ckb")
  nameKmr         String?   @map("name_kmr")
  description     String?
  unit            StockUnit @default(PIECES)
  quantityInStock Int       @default(0) @map("quantity_in_stock")
  reorderPoint    Int       @default(10) @map("reorder_point")
  reorderQuantity Int       @default(50) @map("reorder_quantity")
  costPrice       Decimal?  @map("cost_price") @db.Decimal(10, 2)
  sellingPrice    Decimal?  @map("selling_price") @db.Decimal(10, 2)
  expiryDate      DateTime? @map("expiry_date")
  location        String?
  active          Boolean   @default(true)
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  tenant             Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category           InventoryCategory?  @relation(fields: [categoryId], references: [id])
  supplier           Supplier?           @relation(fields: [supplierId], references: [id])
  movements          InventoryMovement[]
  purchaseOrderItems PurchaseOrderItem[]

  @@unique([tenantId, sku])
  @@index([tenantId, categoryId])
  @@index([tenantId, supplierId])
  @@index([tenantId, quantityInStock])
  @@map("inventory_items")
}

// Movement types for inventory audit trail
enum MovementType {
  PURCHASE // Stock received from purchase order
  SALE // Stock sold/used
  ADJUSTMENT_IN // Manual increase
  ADJUSTMENT_OUT // Manual decrease
  TRANSFER_IN // Transfer from another location
  TRANSFER_OUT // Transfer to another location
  RETURN // Returned items
  EXPIRED // Expired items removed
  DAMAGED // Damaged items removed
  INITIAL // Initial stock count
}

// Inventory Movement - Audit trail for all stock changes
model InventoryMovement {
  id             String       @id @default(cuid())
  tenantId       String       @map("tenant_id")
  itemId         String       @map("item_id")
  type           MovementType
  quantity       Int
  quantityBefore Int          @map("quantity_before")
  quantityAfter  Int          @map("quantity_after")
  unitCost       Decimal?     @map("unit_cost") @db.Decimal(10, 2)
  reference      String?
  referenceId    String?      @map("reference_id")
  notes          String?
  performedBy    String       @map("performed_by")
  createdAt      DateTime     @default(now()) @map("created_at")

  tenant Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  item   InventoryItem @relation(fields: [itemId], references: [id])
  user   User          @relation("InventoryMovements", fields: [performedBy], references: [id])

  @@index([tenantId, itemId])
  @@index([tenantId, createdAt])
  @@index([tenantId, type])
  @@map("inventory_movements")
}

// Supplier - Supplier contact and information
model Supplier {
  id            String   @id @default(cuid())
  tenantId      String   @map("tenant_id")
  name          String
  contactPerson String?  @map("contact_person")
  email         String?
  phone         String?
  address       String?
  taxNumber     String?  @map("tax_number")
  paymentTerms  String?  @map("payment_terms")
  notes         String?
  active        Boolean  @default(true)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  items          InventoryItem[]
  purchaseOrders PurchaseOrder[]

  @@index([tenantId])
  @@map("suppliers")
}

// Purchase Order Status
enum PurchaseOrderStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  ORDERED
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
}

// Purchase Order - Purchase orders with approval workflow
model PurchaseOrder {
  id           String              @id @default(cuid())
  tenantId     String              @map("tenant_id")
  supplierId   String              @map("supplier_id")
  orderNumber  String              @map("order_number")
  status       PurchaseOrderStatus @default(DRAFT)
  orderDate    DateTime            @map("order_date")
  expectedDate DateTime?           @map("expected_date")
  subtotal     Decimal             @db.Decimal(10, 2)
  tax          Decimal?            @db.Decimal(10, 2)
  shipping     Decimal?            @db.Decimal(10, 2)
  total        Decimal             @db.Decimal(10, 2)
  notes        String?
  approvedBy   String?             @map("approved_by")
  approvedAt   DateTime?           @map("approved_at")
  receivedBy   String?             @map("received_by")
  receivedAt   DateTime?           @map("received_at")
  createdBy    String              @map("created_by")
  createdAt    DateTime            @default(now()) @map("created_at")
  updatedAt    DateTime            @updatedAt @map("updated_at")

  tenant   Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  supplier Supplier            @relation(fields: [supplierId], references: [id])
  items    PurchaseOrderItem[]
  approver User?               @relation("PurchaseOrderApprover", fields: [approvedBy], references: [id])
  receiver User?               @relation("PurchaseOrderReceiver", fields: [receivedBy], references: [id])
  creator  User                @relation("PurchaseOrderCreator", fields: [createdBy], references: [id])

  @@unique([tenantId, orderNumber])
  @@index([tenantId, status])
  @@index([tenantId, supplierId])
  @@index([tenantId, createdAt])
  @@map("purchase_orders")
}

// Purchase Order Item - Line items for purchase orders
model PurchaseOrderItem {
  id               String  @id @default(cuid())
  purchaseOrderId  String  @map("purchase_order_id")
  itemId           String  @map("item_id")
  quantity         Int
  receivedQuantity Int     @default(0) @map("received_quantity")
  unitCost         Decimal @map("unit_cost") @db.Decimal(10, 2)
  total            Decimal @db.Decimal(10, 2)

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  item          InventoryItem @relation(fields: [itemId], references: [id])

  @@map("purchase_order_items")
}

// ===========================================
// MILESTONE 9: Staff Scheduling
// ===========================================

// Schedule Template - Reusable schedule patterns
model ScheduleTemplate {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  name        String
  description String?
  isDefault   Boolean  @default(false) @map("is_default")
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  tenant Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  slots  ScheduleTemplateSlot[]

  @@index([tenantId])
  @@map("schedule_templates")
}

// Schedule Template Slot - Time slots within templates
model ScheduleTemplateSlot {
  id         String  @id @default(cuid())
  templateId String  @map("template_id")
  dayOfWeek  Int     @map("day_of_week") // 0=Sunday, 6=Saturday
  startTime  String  @map("start_time") // HH:mm format
  endTime    String  @map("end_time") // HH:mm format
  breakStart String? @map("break_start")
  breakEnd   String? @map("break_end")

  template ScheduleTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId, dayOfWeek])
  @@map("schedule_template_slots")
}

// Work Schedule - Actual daily schedules per user/branch
model WorkSchedule {
  id         String   @id @default(cuid())
  tenantId   String   @map("tenant_id")
  userId     String   @map("user_id")
  branchId   String   @map("branch_id")
  date       DateTime @db.Date
  startTime  String   @map("start_time") // HH:mm format
  endTime    String   @map("end_time") // HH:mm format
  breakStart String?  @map("break_start")
  breakEnd   String?  @map("break_end")
  notes      String?
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation("UserWorkSchedules", fields: [userId], references: [id])
  branch Branch @relation(fields: [branchId], references: [id])

  @@unique([tenantId, userId, branchId, date])
  @@index([tenantId, userId, date])
  @@index([tenantId, branchId, date])
  @@map("work_schedules")
}

// Time Off types
enum TimeOffType {
  VACATION
  SICK_LEAVE
  PERSONAL
  MATERNITY
  PATERNITY
  BEREAVEMENT
  UNPAID
  OTHER
}

// Time Off Status
enum TimeOffStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

// Time Off Request - Vacation/sick leave requests with approval
model TimeOffRequest {
  id          String        @id @default(cuid())
  tenantId    String        @map("tenant_id")
  userId      String        @map("user_id")
  type        TimeOffType
  startDate   DateTime      @map("start_date") @db.Date
  endDate     DateTime      @map("end_date") @db.Date
  reason      String?
  status      TimeOffStatus @default(PENDING)
  reviewedBy  String?       @map("reviewed_by")
  reviewedAt  DateTime?     @map("reviewed_at")
  reviewNotes String?       @map("review_notes")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user     User   @relation("UserTimeOffRequests", fields: [userId], references: [id])
  reviewer User?  @relation("TimeOffReviewer", fields: [reviewedBy], references: [id])

  @@index([tenantId, userId])
  @@index([tenantId, status])
  @@index([tenantId, startDate, endDate])
  @@map("time_off_requests")
}

// ===========================================
// MILESTONE 9: Integrations
// ===========================================

// Integration Provider types
enum IntegrationProvider {
  // SMS Providers
  TWILIO_SMS
  // WhatsApp Providers
  TWILIO_WHATSAPP
  // Payment Providers
  STRIPE
  TAP_PAYMENTS
  HYPERPAY
}

// Integration Type
enum IntegrationType {
  SMS
  WHATSAPP
  PAYMENT
}

// Integration Config - Provider credentials & settings (encrypted)
model IntegrationConfig {
  id              String              @id @default(cuid())
  tenantId        String              @map("tenant_id")
  provider        IntegrationProvider
  type            IntegrationType
  displayName     String              @map("display_name")
  credentials     String // Encrypted JSON
  settings        Json?
  isActive        Boolean             @default(false) @map("is_active")
  isDefault       Boolean             @default(false) @map("is_default")
  lastTestedAt    DateTime?           @map("last_tested_at")
  lastTestSuccess Boolean?            @map("last_test_success")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  tenant Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  logs   IntegrationLog[]

  @@unique([tenantId, provider])
  @@index([tenantId, type])
  @@index([tenantId, isActive])
  @@map("integration_configs")
}

// Integration Log Status
enum IntegrationLogStatus {
  SUCCESS
  FAILED
  PENDING
}

// Integration Log - Activity log for all integration actions
model IntegrationLog {
  id           String               @id @default(cuid())
  tenantId     String               @map("tenant_id")
  configId     String               @map("config_id")
  action       String // e.g., "send_sms", "process_payment"
  status       IntegrationLogStatus
  request      Json?
  response     Json?
  errorMessage String?              @map("error_message")
  durationMs   Int?                 @map("duration_ms")
  entityType   String?              @map("entity_type")
  entityId     String?              @map("entity_id")
  triggeredBy  String?              @map("triggered_by")
  createdAt    DateTime             @default(now()) @map("created_at")

  tenant Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  config IntegrationConfig @relation(fields: [configId], references: [id])
  user   User?             @relation("IntegrationLogTriggeredBy", fields: [triggeredBy], references: [id])

  @@index([tenantId, configId])
  @@index([tenantId, createdAt])
  @@index([tenantId, status])
  @@map("integration_logs")
}

// ===========================================
// MILESTONE 9: PWA / Push Notifications
// ===========================================

// Push Subscription - Web push subscription data
model PushSubscription {
  id         String    @id @default(cuid())
  tenantId   String    @map("tenant_id")
  userId     String    @map("user_id")
  endpoint   String
  p256dh     String // Public key for encryption
  auth       String // Auth secret
  userAgent  String?   @map("user_agent")
  isActive   Boolean   @default(true) @map("is_active")
  lastUsedAt DateTime? @map("last_used_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation("UserPushSubscriptions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, endpoint])
  @@index([tenantId, userId])
  @@index([tenantId, isActive])
  @@map("push_subscriptions")
}
